<%#
kind: job_template
name: Update packages by search query - Katello Ansible Default
job_category: Katello via Ansible
description_format: 'Update package(s) %{Packages search query}'
feature: katello_package_update_by_search
provider_type: Ansible
template_inputs:
- name: Packages search query
  description: Filter criteria for packages to be updated.
  input_type: user
  required: false
- name: Selected update versions
  description: JSON string of selected package versions to be updated, in the format [ nvra ]. Leave blank to upgrade to latest available version.
  input_type: user
  required: false
  value_type: plain
%>
<% package_names = @host.package_names_for_job_template(
  action: 'update',
  search: input('Packages search query'),
  versions: input('Selected update versions')
) -%>
<% if package_names.empty? -%>
<%= render_template('Package Action - Ansible Default', :state => 'latest', :name => '*') %>
<% else -%>
---
- hosts: all
  tasks:
    - name: Collect bootc status
      shell:
        cmd: 'bootc status --json'
      register: bootc_status
      ignore_errors: true
    - name: Parse bootc status json
      set_fact:
        bootc_status_json: "{{ bootc_status.stdout | from_json }}"
      when: bootc_status.rc == 0
    - name: Enable bootc overlay
      shell:
        cmd: 'bootc usr-overlay'
      register: out
      ignore_errors: true
      when: bootc_status_json is defined and bootc_status_json['status']['booted'] != 'null'
    - debug: var=out
    - name: Install packages via dnf for image mode machines
      package:
        name: <%= indent(10) { to_yaml(package_names).gsub(/---/, "") } -%>
        state: latest
        use: 'dnf'
      when: bootc_status_json is defined and bootc_status_json['status']['booted'] != 'null'
    - name: Install packages normally
      package:
        name: <%= indent(10) { to_yaml(package_names).gsub(/---/, "") } -%>
        state: latest
      when: bootc_status_json is not defined or bootc_status_json['status']['booted'] == 'null'
<% end -%>
